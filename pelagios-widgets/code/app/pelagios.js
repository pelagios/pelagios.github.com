/**
 * Pelagios common library
 * @license GPL v3(see LICENSE.txt)
 */

define(["jquery","app/dataset","app/util","app/search_map","app/place_map","lib/text!template/widget_container.tmpl","lib/text!template/place.tmpl","lib/text!template/section.tmpl","lib/text!template/flickr.tmpl","lib/text!template/pleiades.tmpl","lib/text!template/pelagios_partner.tmpl","lib/text!template/error.tmpl","lib/text!template/search.tmpl","lib/text!template/annotations.tmpl","lib/text!template/search_results.tmpl"],function($,dataset,util,search_map,place_map,widget_container_tmpl,place_tmpl,section_tmpl,flickr_tmpl,pleiades_tmpl,pelagios_partner_tmpl,error_tmpl,search_tmpl,annotations_tmpl,search_results_tmpl){function Widget(widgetContext){function displayPlace(pleiadesID){debug("DISPLAYING PLACE: pleiadesID: "+pleiadesID),placeMap={},clearPlace(),showPleiadesData(pleiadesID),showPelagiosData(pleiadesID),showFlickrData(pleiadesID)}function clearPlace(){$("#"+widgetContext.widgetID+"-pleiades").empty(),$("#"+widgetContext.widgetID+"-sections").empty()}function showFlickrData(pleiadesID){function displayFlickrData(json){if(json.hasOwnProperty("photos")&&json.photos.hasOwnProperty("photo")&&json.photos.photo.length>0){addSection("flickr","flickr",widgetContext.imageDir+"icons/flickr-logo.png","Photo sharing website");var data={photo:json.photos.photo.slice(0,config.MAX_PHOTOS_FLICKR-1),pleiadesID:pleiadesID},html=Handlebars.templates.flickr(data);$("#"+widgetContext.widgetID+"-content-flickr").append(html)}}var flickrURL=config.URL_FLICKR_SEARCH+"&machine_tags=pleiades:depicts="+pleiadesID+"&group_id=1876758@N22&tag_mode=all&api_key="+config.API_KEY_FLICKR+"&jsoncallback=?";util.getAPIData(flickrURL,displayFlickrData,!1,config.TIMEOUT_FLICKR,!1)}function showPleiadesData(pleiadesID){function displayPleiadesError(jqXHR,textStatus,errorThrown){$("#"+widgetContext.widgetID+"-content").empty();if(jqXHR.status=="404")var data={title:config.MSG_TITLE_PLACE_NOT_FOUND,msg:config.MSG_PLACE_NOT_FOUND};else var data={title:config.MSG_TITLE_PLEIADES_TIMEOUT,msg:config.MSG_PLEIADES_TIMEOUT};var html=Handlebars.templates.error(data);$("#"+widgetContext.widgetID+"-content").append(html)}function displayPleiadesData(data){var altNames=!1;data.names.length>1&&(altNames=data.names.join(", "));var placeData={title:data.names[0]?data.names[0]:"Untitled",description:data.description,altNames:altNames,pleiadesID:data.id,widgetContext:widgetContext},html=Handlebars.templates.pleiades(placeData);$("#"+widgetContext.widgetID+"-pleiades").append(html),widgetContext.displayMap&&(placeMap=new place_map.PlaceMap(widgetContext.widgetID+"-map_canvas"),placeMap.setMarker(data.reprPoint,data.names[0])),showPlace()}var pleiadesURI=config.URL_PLEIADES+pleiadesID,pleiadesAPIURL=config.URL_PLEIADES+pleiadesID+"/json";util.getAPIData(pleiadesAPIURL,displayPleiadesData,displayPleiadesError,config.TIMEOUT_PLEIADES,!0)}function showPelagiosData(pleiadesID){function displayPelagiosData(json){var items=[],data={};$.each(json,function(key,val){data[val.rootDataset]=data[val.rootDataset]||[],data[val.rootDataset].push(val)}),$.each(data,function(rootDataset,info){var rootDatasetID=util.createID(rootDataset);addSection(rootDatasetID,rootDataset,widgetContext.iconDir+dataset.getDatasetIconURL(rootDataset),dataset.getDatasetStrapline(rootDataset));var subdataset=new Array;for(var i=0;i<info.length;i++)subdataset[i]={},subdataset[i].widgetContext=widgetContext,subdataset[i].title=info[i].dataset,subdataset[i].id=util.createID(info[i].dataset),subdataset[i].references=info[i].referencesTo,subdataset[i].multipleReferences=subdataset[i].references>1?!0:!1;var data={subdataset:subdataset,rootDatasetID:rootDatasetID,widgetContext:widgetContext},html=Handlebars.templates.pelagios_partner(data);$("#"+widgetContext.widgetID+"-content-"+rootDatasetID).append(html),$("#"+widgetContext.widgetID+"-subdatasets-"+rootDatasetID).css("list-style-image","url("+widgetContext.imageDir+"icons/bullet.png)");for(var i=0;i<subdataset.length;i++)$("#"+widgetContext.widgetID+"-toggle-subdataset-"+subdataset[i].id).click({subdataset:subdataset[i].title},clickDisplaySubdataset),$("#"+widgetContext.widgetID+"-subdataset_content-"+subdataset[i].id).hide()})}function clickDisplaySubdataset(data){var subdataset=data.data.subdataset,subdatasetID=util.createID(subdataset);$("#"+widgetContext.widgetID+"-annotations_pane-"+subdatasetID).hide();var loadingElement=$("#"+widgetContext.widgetID+"-loading-"+subdatasetID);loadingElement.append("<p>Loading</p>"),loadingElement.show(),toggleSelectedLink(widgetContext.widgetID+"-subdataset_hits-"+subdatasetID),$("#"+widgetContext.widgetID+"-subdataset_content-"+subdatasetID).toggle(),toggleIcon(widgetContext.widgetID+"-toggle-subdataset-"+subdatasetID);var url=config.URL_PELAGIOS_ANNOTATIONS_V1+"?place="+config.URL_PLEIADES+pleiadesID+"&dataset="+encodeURIComponent(subdataset)+"&callback=?";$.getJSON(url,function(json){displaySubdataset(subdatasetID,json)})}function displaySubdataset(subdatasetID,json){$("#"+widgetContext.widgetID+"-loading-"+subdatasetID).hide();var paneElement=$("#"+widgetContext.widgetID+"-annotations_pane-"+subdatasetID);paneElement.show(),paneElement.text("");var annotation=new Array;$.each(json,function(key,val){annotation[key]={},dataset.hasDatasetMeaningfulLabel(json[0].rootDataset)?annotation[key].label=val.label?val.label:"Item "+(key+1):annotation[key].label="Item "+(key+1),annotation[key].uri=val.uri});var data={subdatasetID:subdatasetID,annotation:annotation,widgetContext:widgetContext},html=Handlebars.templates.annotations(data);$("#"+widgetContext.widgetID+"-annotations_pane-"+subdatasetID).append(html)}function hideSubdataset(id){$("#"+widgetID+"-subdataset_content-"+id).hide()}if(widgetContext.pelagiosAPIversion==1)var pelagiosURL=config.URL_PELAGIOS_REFERENCES_V1+"?place="+config.URL_PLEIADES+pleiadesID+"&callback=?";else var pelagiosURL=config.URL_PELAGIOS_REFERENCES_V1+"?place="+config.URL_PLEIADES+pleiadesID+"&callback=?";util.getAPIData(pelagiosURL,displayPelagiosData,!1,config.TIMEOUT_PELAGIOS,!1)}function displaySearchResults(){if(widgetContext.pelagiosAPIversion==1)var pelagiosURL=config.URL_PELAGIOS_SEARCH_V1+"?q="+searchString+"&callback=?";else if(widgetContext.pelagiosAPIversion==2)var pelagiosURL=config.URL_PELAGIOS_SEARCH_V2+"?query="+searchString+"&callback=?";debug("RETRIEVING SEARCH DATA: searchString: "+searchString+" URL:"+pelagiosURL),util.getAPIData(pelagiosURL,displaySearchResultsData,!1,config.TIMEOUT_PELAGIOS,!1)}function displaySearchResultsData(json){function onClickHandler(pleiadesID){$(".pelagios-search-result-list li").css("text-decoration","none"),$(".pelagios-search-result-list li").css("font-weight","normal"),$("#"+widgetContext.widgetID+"-place-"+pleiadesID).css("text-decoration","underline"),$("#"+widgetContext.widgetID+"-place-"+pleiadesID).css("font-weight","bold"),displayPlace(pleiadesID)}debug("SEARCH DATA RECEIVED"),$("#"+widgetContext.widgetID+"-search-map").empty(),$("#"+widgetContext.widgetID+"-search-results").empty(),$("#"+widgetContext.widgetID+"-pleiades").empty(),$("#"+widgetContext.widgetID+"-sections").empty();var places=new Array;$.each(json,function(key,val){place={},place.label=val.label,place.pleiadesID=val.uri.replace(/.*places.*F/g,""),place.geojson=val,place.content="<h2>"+place.label+"</h2>",place.content+='<p id="'+widgetContext.widgetID+"-info-"+place.pleiadesID+'">View info</p>',place.widgetID=widgetContext.widgetID,places[key]=place});var data={place:places,widgetContext:widgetContext,searchString:searchString},html=Handlebars.templates.search_results(data);$("#"+widgetContext.widgetID+"-search-results").append(html),widgetContext.displayMap&&(searchMap=new search_map.SearchMap(widgetContext.widgetID+"-search-map_canvas")),$.each(places,function(key,place){widgetContext.displayMap&&searchMap.addMarker(place.geojson,place.label,place.content,function(){onClickHandler(place.pleiadesID)}),$("#"+widgetContext.widgetID+"-place-"+place.pleiadesID).click(function(){onClickHandler(place.pleiadesID)})}),showSearchResults()}function hideSearchResults(){$("#"+widgetContext.widgetID+"-search-results-map").hide(),$("#"+widgetContext.widgetID+"-search-results").hide()}function showSearchResults(){widgetContext.displayMap&&($("#"+widgetContext.widgetID+"-search-results-map").show(),searchMap.refresh()),$("#"+widgetContext.widgetID+"-search-results").show()}function hidePlace(){$("#"+widgetContext.widgetID+"-map").hide(),$("#"+widgetContext.widgetID+"-place").hide()}function showPlace(){$("#"+widgetContext.widgetID+"-place").show(),widgetContext.displayMap&&($("#"+widgetContext.widgetID+"-map").show(),placeMap.refresh())}function addSection(name,title,iconURL,strapline){var data={name:name,title:title,iconURL:iconURL,strapline:strapline,widgetContext:widgetContext},html=Handlebars.templates.section(data);$("#"+widgetContext.widgetID+"-sections").append(html),$("#"+widgetContext.widgetID+"-content-"+name).hide(),$("#"+widgetContext.widgetID+"-header-"+name).click(function(){$("#"+widgetContext.widgetID+"-content-"+name).toggle(),toggleIcon(widgetContext.widgetID+"-toggle-"+name)})}function toggleIcon(id){var current_icon=$("#"+id).attr("src"),new_icon=current_icon==widgetContext.imageDir+"icons/down-arrow.png"?widgetContext.imageDir+"icons/right-arrow.png":widgetContext.imageDir+"icons/down-arrow.png";$("#"+id).attr("src",new_icon)}function toggleSelectedLink(id){var element=$("#"+id),current_style=element.css("text-decoration"),new_style=current_style=="underline"?"none":"underline";element.css("text-decoration",new_style)}function debug(msg){widgetContext.debug&&console.log(msg)}var placeMap={},searchMap={},searchString="";eval(widget_container_tmpl),eval(place_tmpl),eval(section_tmpl),eval(flickr_tmpl),eval(pleiades_tmpl),eval(pelagios_partner_tmpl),eval(error_tmpl),eval(search_tmpl),eval(annotations_tmpl),eval(search_results_tmpl),typeof $("#"+widgetContext.widgetID)==undefined&&debug("ERROR: $(#"+widgetContext.widgetID+") is undefined"),$("head").append('<link rel="stylesheet" type="text/css" href="'+widgetContext.cssDir+'pelagios.css" media="screen" />');var html=Handlebars.templates.widget_container({widgetContext:widgetContext});$("#"+widgetContext.widgetID).append(html),this.setTypePlace=function(){debug("SETTING WIDGET TYPE: PLACE");var html=Handlebars.templates.place({widgetContext:widgetContext});$("#"+widgetContext.widgetID+"-content").append(html),hidePlace(),widgetContext.overlay==1&&($("#"+widgetContext.widgetID+"-container").hide(),$("#"+widgetContext.widgetID+"-icon").click(function(){$(".pelagios-container").hide(),$("#"+widgetContext.widgetID+"-container").show();var icon_offset=$("#"+widgetContext.widgetID+"-icon").offset(),container_offset={top:$(window).scrollTop(),left:200};$("#"+widgetContext.widgetID+"-container").offset(container_offset),widgetContext.displayMap&&placeMap.hasOwnProperty("refresh")&&placeMap.refresh()}),$("#"+widgetContext.widgetID+"-close-widget").click(function(){$("#"+widgetContext.widgetID+"-container").hide()})),displayPlace(widgetContext.pleiadesID)},this.setTypeSearch=function(){debug("SETTING WIDGET TYPE: SEARCH");var html=Handlebars.templates.search({widgetContext:widgetContext});$("#"+widgetContext.widgetID+"-content").append(html);var html=Handlebars.templates.place({widgetContext:widgetContext});$("#"+widgetContext.widgetID+"-content").append(html),hidePlace(),hideSearchResults(),$("#"+widgetContext.widgetID+"-search-form").submit(function(){return searchString=$("input:first").val(),displaySearchResults(),!1})}}var config={URL_PELAGIOS_SEARCH_V1:"http://pelagios.dme.ait.ac.at/graph-explorer/places/search",URL_PELAGIOS_SEARCH_V2:"http://pelagios.dme.ait.ac.at/api/search.json",URL_PELAGIOS_ANNOTATIONS_V1:"http://pelagios.dme.ait.ac.at/graph-explorer/annotations",URL_PELAGIOS_REFERENCES_V1:"http://pelagios.dme.ait.ac.at/graph-explorer/places/referencesTo",URL_PELAGIOS_REFERENCES_V2:"http://pelagios.dme.ait.ac.at/graph-explorer/places/referencesTo",API_KEY_FLICKR:"ddf82df2aba035bfcf14c12a4eff3335",TIMEOUT_PLEIADES:6e3,TIMEOUT_PELAGIOS:6e4,TIMEOUT_FLICKR:6e3,URL_PLEIADES:"http://pleiades.stoa.org/places/",URL_FLICKR_SEARCH:"http://api.flickr.com/services/rest/?format=json&method=flickr.photos.search",MAX_PHOTOS_FLICKR:30,MSG_PLACE_NOT_FOUND:"The place specified for this widget does not exist in the Pleiades gazetteer.",MSG_TITLE_PLACE_NOT_FOUND:"Error: Unknown Place",MSG_PLEIADES_TIMEOUT:"We cannot display the place name and map at the moment because the Pleiades website is not responding. Apologies for the inconvenience and please try again later.",MSG_TITLE_PLEIADES_TIMEOUT:"Error: Pleiades not responding"};return{Widget:Widget}})