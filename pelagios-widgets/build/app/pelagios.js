define(["jquery","app/dataset","app/util","app/search_map","app/place_map"],function(a,b,c,d,e){function g(g){function k(a){z("DISPLAYING PLACE: pleiadesID: "+a),h={},l(),n(a),o(a),m(a)}function l(){a("#"+g.widgetID+"-pleiades").empty(),a("#"+g.widgetID+"-sections").empty()}function m(a){function d(b){if(b.hasOwnProperty("photos")&&b.photos.hasOwnProperty("photo")&&b.photos.photo.length>0){v("flickr","flickr",g.imageDir+"icons/flickr-logo.png","Photo sharing website");var c={photo:b.photos.photo.slice(0,f.MAX_PHOTOS_FLICKR-1),pleiadesID:a};y(g.widgetID+"-content-flickr","flickr",c)}}var b=f.URL_FLICKR_SEARCH+"&machine_tags=pleiades:depicts="+a+"&group_id=1876758@N22&tag_mode=all&api_key="+f.API_KEY_FLICKR+"&jsoncallback=?";c.getAPIData(b,d,!1,f.TIMEOUT_FLICKR,!1)}function n(b){function j(b,c,d){a("#"+g.widgetID+"-content").empty();if(b.status=="404")var e={title:f.MSG_TITLE_PLACE_NOT_FOUND,msg:f.MSG_PLACE_NOT_FOUND};else var e={title:f.MSG_TITLE_PLEIADES_TIMEOUT,msg:f.MSG_PLEIADES_TIMEOUT};y(g.widgetID+"-content","error",e)}function k(a){var b=!1;a.names.length>1&&(b=a.names.join(", "));var c={title:a.names[0]?a.names[0]:"Untitled",description:a.description,altNames:b,pleiadesID:a.id,widgetContext:g};y(g.widgetID+"-pleiades","pleiades",c),g.displayMap&&(h=new e.PlaceMap(g.widgetID+"-map_canvas"),h.setMarker(a.reprPoint,a.names[0])),u()}var d=f.URL_PLEIADES+b,i=f.URL_PLEIADES+b+"/json";c.getAPIData(i,k,j,f.TIMEOUT_PLEIADES,!0)}function o(d){function h(d){var e=[],f={};a.each(d,function(a,b){f[b.rootDataset]=f[b.rootDataset]||[],f[b.rootDataset].push(b)}),a.each(f,function(d,e){var f=c.createID(d);v(f,d,g.iconDir+b.getDatasetIconURL(d),b.getDatasetStrapline(d));var h=new Array;for(var j=0;j<e.length;j++)h[j]={},h[j].widgetContext=g,h[j].title=e[j].dataset,h[j].id=c.createID(e[j].dataset),h[j].references=e[j].referencesTo,h[j].multipleReferences=h[j].references>1?!0:!1;var k={subdataset:h,rootDatasetID:f,widgetContext:g};y(g.widgetID+"-content-"+f,"pelagios_partner",k),a("#"+g.widgetID+"-subdatasets-"+f).css("list-style-image","url("+g.imageDir+"icons/bullet.png)");for(var j=0;j<h.length;j++)a("#"+g.widgetID+"-toggle-subdataset-"+h[j].id).click({subdataset:h[j].title},i),a("#"+g.widgetID+"-subdataset_content-"+h[j].id).hide()})}function i(b){var e=b.data.subdataset,h=c.createID(e);a("#"+g.widgetID+"-annotations_pane-"+h).hide();var i=a("#"+g.widgetID+"-loading-"+h);i.append("<p>Loading</p>"),i.show(),x(g.widgetID+"-subdataset_hits-"+h),a("#"+g.widgetID+"-subdataset_content-"+h).toggle(),w(g.widgetID+"-toggle-subdataset-"+h);var k=f.URL_PELAGIOS_ANNOTATIONS_V1+"?place="+f.URL_PLEIADES+d+"&dataset="+encodeURIComponent(e)+"&callback=?";a.getJSON(k,function(a){j(h,a)})}function j(c,d){a("#"+g.widgetID+"-loading-"+c).hide();var e=a("#"+g.widgetID+"-annotations_pane-"+c);e.show(),e.text("");var f=new Array;a.each(d,function(a,c){f[a]={},b.hasDatasetMeaningfulLabel(d[0].rootDataset)?f[a].label=c.label?c.label:"Item "+(a+1):f[a].label="Item "+(a+1),f[a].uri=c.uri});var h={subdatasetID:c,annotation:f,widgetContext:g};y(g.widgetID+"-annotations_pane-"+c,"annotations",h)}function k(b){a("#"+widgetID+"-subdataset_content-"+b).hide()}if(g.pelagiosAPIversion==1)var e=f.URL_PELAGIOS_REFERENCES_V1+"?place="+f.URL_PLEIADES+d+"&callback=?";else var e=f.URL_PELAGIOS_REFERENCES_V1+"?place="+f.URL_PLEIADES+d+"&callback=?";c.getAPIData(e,h,!1,f.TIMEOUT_PELAGIOS,!1)}function p(){if(g.pelagiosAPIversion==1)var a=f.URL_PELAGIOS_SEARCH_V1+"?q="+j+"&callback=?";else if(g.pelagiosAPIversion==2)var a=f.URL_PELAGIOS_SEARCH_V2+"?query="+j+"&callback=?";z("RETRIEVING SEARCH DATA: searchString: "+j+" URL:"+a),c.getAPIData(a,q,!1,f.TIMEOUT_PELAGIOS,!1)}function q(b){function f(b){a(".pelagios-search-result-list li").css("text-decoration","none"),a(".pelagios-search-result-list li").css("font-weight","normal"),a("#"+g.widgetID+"-place-"+b).css("text-decoration","underline"),a("#"+g.widgetID+"-place-"+b).css("font-weight","bold"),k(b)}z("SEARCH DATA RECEIVED"),a("#"+g.widgetID+"-search-map").empty(),a("#"+g.widgetID+"-search-results").empty(),a("#"+g.widgetID+"-pleiades").empty(),a("#"+g.widgetID+"-sections").empty();var c=new Array;a.each(b,function(a,b){place={},place.label=b.label,place.pleiadesID=b.uri.replace(/.*places.*F/g,""),place.geojson=b,place.content="<h2>"+place.label+"</h2>",place.content+='<p id="'+g.widgetID+"-info-"+place.pleiadesID+'">View info</p>',place.widgetID=g.widgetID,c[a]=place});var e={place:c,widgetContext:g,searchString:j};y(g.widgetID+"-search-results","search_results",e),g.displayMap&&(i=new d.SearchMap(g.widgetID+"-search-map_canvas")),a.each(c,function(b,c){g.displayMap&&i.addMarker(c.geojson,c.label,c.content,function(){f(c.pleiadesID)}),a("#"+g.widgetID+"-place-"+c.pleiadesID).click(function(){f(c.pleiadesID)})}),s()}function r(){a("#"+g.widgetID+"-search-results-map").hide(),a("#"+g.widgetID+"-search-results").hide()}function s(){g.displayMap&&(a("#"+g.widgetID+"-search-results-map").show(),i.refresh()),a("#"+g.widgetID+"-search-results").show()}function t(){a("#"+g.widgetID+"-map").hide(),a("#"+g.widgetID+"-place").hide()}function u(){a("#"+g.widgetID+"-place").show(),g.displayMap&&(a("#"+g.widgetID+"-map").show(),h.refresh())}function v(b,c,d,e){var f={name:b,title:c,iconURL:d,strapline:e,widgetContext:g};y(g.widgetID+"-sections","section",f),a("#"+g.widgetID+"-content-"+b).hide(),a("#"+g.widgetID+"-header-"+b).click(function(){a("#"+g.widgetID+"-content-"+b).toggle(),w(g.widgetID+"-toggle-"+b)})}function w(b){var c=a("#"+b).attr("src"),d=c==g.imageDir+"icons/down-arrow.png"?g.imageDir+"icons/right-arrow.png":g.imageDir+"icons/down-arrow.png";a("#"+b).attr("src",d)}function x(b){var c=a("#"+b),d=c.css("text-decoration"),e=d=="underline"?"none":"underline";c.css("text-decoration",e)}function y(b,c,d){typeof a("#"+b)==undefined&&z("ERROR: $(#"+b+") not defined"),a("#"+b).append('<script src="'+g.templateDir+c+'.tmpl">');try{var e=Handlebars.templates[c](d)}catch(f){z("Handlebars.templates[template](data) failed"),console.log(Handlebars),console.log(c),console.log(d)}a("#"+b).append(e)}function z(a){g.debug&&console.log(a)}var h={},i={},j="";typeof a("#"+g.widgetID)==undefined&&z("ERROR: $(#"+g.widgetID+") is undefined"),a("head").append('<link rel="stylesheet" type="text/css" href="'+g.cssDir+'pelagios.css" media="screen" />'),y(g.widgetID,"widget_container",{widgetContext:g}),this.setTypePlace=function(){z("SETTING WIDGET TYPE: PLACE"),y(g.widgetID+"-content","place",{widgetContext:g}),t(),g.overlay==1&&(a("#"+g.widgetID+"-container").hide(),a("#"+g.widgetID+"-icon").click(function(){a(".pelagios-container").hide(),a("#"+g.widgetID+"-container").show();var b=a("#"+g.widgetID+"-icon").offset(),c={top:a(window).scrollTop(),left:200};a("#"+g.widgetID+"-container").offset(c),g.displayMap&&h.hasOwnProperty("refresh")&&h.refresh()}),a("#"+g.widgetID+"-close-widget").click(function(){a("#"+g.widgetID+"-container").hide()})),k(g.pleiadesID)},this.setTypeSearch=function(){z("SETTING WIDGET TYPE: SEARCH"),y(g.widgetID+"-content","search",{widgetContext:g}),y(g.widgetID+"-content","place",{widgetContext:g}),t(),r(),a("#"+g.widgetID+"-search-form").submit(function(){return j=a("input:first").val(),p(),!1})}}var f={URL_PELAGIOS_SEARCH_V1:"http://pelagios.dme.ait.ac.at/graph-explorer/places/search",URL_PELAGIOS_SEARCH_V2:"http://pelagios.dme.ait.ac.at/api/search.json",URL_PELAGIOS_ANNOTATIONS_V1:"http://pelagios.dme.ait.ac.at/graph-explorer/annotations",URL_PELAGIOS_REFERENCES_V1:"http://pelagios.dme.ait.ac.at/graph-explorer/places/referencesTo",URL_PELAGIOS_REFERENCES_V2:"http://pelagios.dme.ait.ac.at/graph-explorer/places/referencesTo",API_KEY_FLICKR:"ddf82df2aba035bfcf14c12a4eff3335",TIMEOUT_PLEIADES:6e3,TIMEOUT_PELAGIOS:6e4,TIMEOUT_FLICKR:6e3,URL_PLEIADES:"http://pleiades.stoa.org/places/",URL_FLICKR_SEARCH:"http://api.flickr.com/services/rest/?format=json&method=flickr.photos.search",MAX_PHOTOS_FLICKR:30,MSG_PLACE_NOT_FOUND:"The place specified for this widget does not exist in the Pleiades gazetteer.",MSG_TITLE_PLACE_NOT_FOUND:"Error: Unknown Place",MSG_PLEIADES_TIMEOUT:"We cannot display the place name and map at the moment because the Pleiades website is not responding. Apologies for the inconvenience and please try again later.",MSG_TITLE_PLEIADES_TIMEOUT:"Error: Pleiades not responding"};return{Widget:g}})