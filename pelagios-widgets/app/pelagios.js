/**
 * Pelagios common library
 * @license GPL v3(see LICENSE.txt)
 */

define(["jquery","app/util","app/search_map","app/place_map","lib/text!template/widget_container.tmpl","lib/text!template/place.tmpl","lib/text!template/section.tmpl","lib/text!template/flickr.tmpl","lib/text!template/pleiades.tmpl","lib/text!template/pelagios_partner.tmpl","lib/text!template/error.tmpl","lib/text!template/search.tmpl","lib/text!template/annotations.tmpl","lib/text!template/search_results.tmpl","lib/text!template/new_tab.tmpl","lib/text!template/about.tmpl","lib/text!app/dataset.json","jqueryui","lib/jquery_pagination"],function($,util,search_map,place_map,widget_container_tmpl,place_tmpl,section_tmpl,flickr_tmpl,pleiades_tmpl,pelagios_partner_tmpl,error_tmpl,search_tmpl,annotations_tmpl,search_results_tmpl,new_tab_tmpl,about_tmpl,datasetJSON){function Widget(widgetContext){function addAboutSection(){}function widgetPopUp(){if(widgetContext.newTab){var w=window.open(),html=Handlebars.templates.new_tab({widgetContext:widgetContext});$(w.document.body).html(html);var script1=document.createElement("script");script1.type="text/javascript",script1.src=widgetContext.baseURL+"lib/require.js",w.document.head.appendChild(script1);var script2=document.createElement("script");script2.type="text/javascript",script2.src=widgetContext.baseURL+"place.js",w.document.head.appendChild(script2)}else{$(".pelagios .container").hide(),$("#"+widgetContext.widgetID+"-container").show();var icon_offset=$("#"+widgetContext.widgetID+"-icon").offset(),container_offset={top:$(window).scrollTop(),left:200};$("#"+widgetContext.widgetID+"-container").offset(container_offset),widgetContext.displayMap&&placeMap.hasOwnProperty("refresh")&&placeMap.refresh()}}function displayPlace(pleiadesID){debug("DISPLAYING PLACE: pleiadesID: "+pleiadesID),placeMap={},clearPlace(),showPleiadesData(pleiadesID),widgetContext.type=="place"&&showAboutInformation(),showPelagiosData(pleiadesID),showFlickrData(pleiadesID)}function showAboutInformation(){addSection("about","About Pelagios and this widget",widgetContext.imageDir+"partner_icons/pelagios.png","");var html=Handlebars.templates.about();$("#"+widgetContext.widgetID+"-content-about").append(html)}function clearPlace(){$("#"+widgetContext.widgetID+"-pleiades").empty(),$("#"+widgetContext.widgetID+"-sections").empty()}function showFlickrData(pleiadesID){function displayFlickrData(json){if(json.hasOwnProperty("photos")&&json.photos.hasOwnProperty("photo")&&json.photos.photo.length>0){addSection("flickr","flickr",widgetContext.imageDir+"icons/flickr-logo.png","Photo sharing website");var data={photo:json.photos.photo.slice(0,config.MAX_PHOTOS_FLICKR-1),pleiadesID:pleiadesID},html=Handlebars.templates.flickr(data);$("#"+widgetContext.widgetID+"-content-flickr").append(html)}}var groupURIComponent="";widgetContext.pleiadesFlickrGroupOnly&&(groupURIComponent="&group_id=1876758@N22");var url=config.URL_FLICKR_SEARCH+"&machine_tags=pleiades:depicts="+pleiadesID+groupURIComponent+"&tag_mode=all&api_key="+config.API_KEY_FLICKR+"&jsoncallback=?";util.getAPIData(url,displayFlickrData,!1,config.TIMEOUT_FLICKR,!1)}function showPleiadesData(pleiadesID){function displayPleiadesError(jqXHR,textStatus,errorThrown){$("#"+widgetContext.widgetID+"-content").empty();if(jqXHR.status=="404")var data={title:config.MSG_TITLE_PLACE_NOT_FOUND,msg:config.MSG_PLACE_NOT_FOUND};else var data={title:config.MSG_TITLE_PLEIADES_TIMEOUT,msg:config.MSG_PLEIADES_TIMEOUT};var html=Handlebars.templates.error(data);$("#"+widgetContext.widgetID+"-content").append(html)}function displayPleiadesData(data){var altNames=!1;data.names.length>1&&(altNames=data.names.join(", "));var placeData={title:data.names[0]?data.names[0]:"Untitled",description:data.description,altNames:altNames,pleiadesID:data.id,widgetContext:widgetContext},html=Handlebars.templates.pleiades(placeData);$("#"+widgetContext.widgetID+"-pleiades").append(html),widgetContext.displayMap&&(placeMap=new place_map.PlaceMap(widgetContext.widgetID+"-map_canvas"),placeMap.setMarker(data.reprPoint,data.names[0])),showPlace()}var pleiadesURI=config.URL_PLEIADES+pleiadesID,pleiadesAPIURL=config.URL_PLEIADES+pleiadesID+"/json";util.getAPIData(pleiadesAPIURL,displayPleiadesData,displayPleiadesError,config.TIMEOUT_PLEIADES,!0)}function showPelagiosData(pleiadesID){function displayPelagiosData(json){$.each(json,function(key,rootDataset){rootDataset.hasOwnProperty("root_dataset")&&(rootDataset=rootDataset.root_dataset);var rootDatasetInfo;rootDatasetID=rootDataset.uri.replace(/http:\/\/pelagios.dme.ait.ac.at\/api\/datasets\//g,""),rootDatasetInfo=getDatasetInfo(rootDatasetID);if(typeof rootDatasetInfo!="undefined"){addSection(rootDatasetID,rootDatasetInfo.title,widgetContext.iconDir+rootDatasetInfo.iconFileName,rootDatasetInfo.strapline);var subdataset=new Array;if(typeof rootDataset.subsets!="undefined")for(var i=0;i<rootDataset.subsets.length;i++)subdataset[i]={},subdataset[i].widgetContext=widgetContext,subdataset[i].title=rootDataset.subsets[i].title,subdataset[i].id=rootDataset.subsets[i].uri.replace(/http:\/\/pelagios.dme.ait.ac.at\/api\/datasets\//g,""),subdataset[i].references=rootDataset.subsets[i].annotations_referencing_place,subdataset[i].multipleReferences=subdataset[i].references>1?!0:!1,subdataset[i].anyReferences=subdataset[i].references>0?!0:!1;else subdataset[0]={},subdataset[0].widgetContext=widgetContext,subdataset[0].title=rootDataset.title,subdataset[0].id=rootDatasetID,subdataset[0].references=rootDataset.annotations_referencing_place,subdataset[0].multipleReferences=subdataset[0].references>1?!0:!1;var data={subdataset:subdataset,rootDatasetID:rootDatasetID,widgetContext:widgetContext},html=Handlebars.templates.pelagios_partner(data);$("#"+widgetContext.widgetID+"-content-"+rootDatasetID).append(html),$("#"+widgetContext.widgetID+"-subdatasets-"+rootDatasetID).css("list-style-image","url("+widgetContext.imageDir+"icons/bullet.png)");for(var i=0;i<subdataset.length;i++)subdatasetSetup(subdataset[i])}else debug("ERROR: Could not find info for root dataset "+rootDataset.title+" "+pelagiosURL)})}function subdatasetSetup(subdataset){$("#"+widgetContext.widgetID+"-subdataset_title-"+subdataset.id).click({id:subdataset.id},clickDisplaySubdataset),$("#"+widgetContext.widgetID+"-subdataset_content-"+subdataset.id).hide();var callback=function(newPageIndex){handlePaginationClick(newPageIndex,subdataset.id)};$("#"+widgetContext.widgetID+"-subdataset_pagination-"+subdataset.id).pagination(subdataset.references,{items_per_page:config.NUM_ANNOTATIONS_TO_DISPLAY,callback:callback}),handlePaginationClick(0,subdataset.id)}function handlePaginationClick(newPageIndex,subdatasetID){var url=config.URL_PELAGIOS_API_V2+"datasets/"+subdatasetID+"/annotations.json?forPlace="+encodeURIComponent(config.URL_PLEIADES+pleiadesID)+"&limit="+config.NUM_ANNOTATIONS_TO_DISPLAY+"&offset="+newPageIndex*config.NUM_ANNOTATIONS_TO_DISPLAY+"&callback=?",success=function(json){typeof json.annotations!="undefined"&&json.annotations.length>0&&displayAnnotations(json.annotations,subdatasetID)};return util.getAPIData(url,success),!1}function displayAnnotations(annotations,subsetID){var annotation=new Array;$.each(annotations,function(key,val){annotation[key]={},val.hasOwnProperty("target_title")?annotation[key].label=val.target_title:annotation[key].label=val.title?val.title:"Item "+(key+1),annotation[key].uri=val.hasTarget});var data={subdatasetID:subsetID,annotation:annotation,widgetContext:widgetContext},html=Handlebars.templates.annotations(data);$("#"+widgetContext.widgetID+"-annotations-"+subsetID).empty(),$("#"+widgetContext.widgetID+"-annotations-"+subsetID).append(html),$("#"+widgetContext.widgetID+"-subdataset-"+subsetID).focus()}function clickDisplaySubdataset(data){var subdatasetID=data.data.id;toggleSelectedLink(widgetContext.widgetID+"-subdataset_hits-"+subdatasetID),$("#"+widgetContext.widgetID+"-subdataset_content-"+subdatasetID).toggle(),toggleIcon(widgetContext.widgetID+"-toggle-subdataset-"+subdatasetID)}function hideSubdataset(id){$("#"+widgetID+"-subdataset_content-"+id).hide()}var pelagiosURL=config.URL_PELAGIOS_API_V2+"places/"+encodeURIComponent(config.URL_PLEIADES+pleiadesID)+"/datasets.json?callback=?";util.getAPIData(pelagiosURL,displayPelagiosData,!1,config.TIMEOUT_PELAGIOS,!1)}function displaySearchResults(){var pelagiosURL=config.URL_PELAGIOS_API_V2+"search.json?query="+searchString+"&callback=?";debug("RETRIEVING SEARCH DATA: searchString: "+searchString+" URL:"+pelagiosURL),util.getAPIData(pelagiosURL,displaySearchResultsData,!1,config.TIMEOUT_PELAGIOS,!1)}function displaySearchResultsData(json){$("#"+widgetContext.widgetID+"-search-map").empty(),$("#"+widgetContext.widgetID+"-search-results").empty(),$("#"+widgetContext.widgetID+"-pleiades").empty(),$("#"+widgetContext.widgetID+"-sections").empty();if(json.length>0){var places=new Array;$.each(json,function(key,val){place={},place.label=val.label,place.pleiadesID=val.uri.replace(/.*places.*F/g,""),place.geojson=val,place.content="<h2>"+place.label+"</h2>",place.content+='<p id="'+widgetContext.widgetID+"-info-"+place.pleiadesID+'">View info</p>',place.widgetID=widgetContext.widgetID,places[key]=place});var data={place:places,widgetContext:widgetContext,searchString:searchString},html=Handlebars.templates.search_results(data);$("#"+widgetContext.widgetID+"-search-results").append(html),widgetContext.displayMap&&(searchMap=new search_map.SearchMap(widgetContext.widgetID+"-search-map_canvas")),$.each(places,function(key,place){widgetContext.displayMap&&searchMap.addMarker(place.geojson,place.label,place.content,function(){onClickHandler(place.pleiadesID)}),$("#"+widgetContext.widgetID+"-place-"+place.pleiadesID).click(function(){onClickHandler(place.pleiadesID)})});function onClickHandler(pleiadesID){$(".pelagios-search-result-list li").css("text-decoration","none"),$(".pelagios-search-result-list li").css("font-weight","normal"),$("#"+widgetContext.widgetID+"-place-"+pleiadesID).css("text-decoration","underline"),$("#"+widgetContext.widgetID+"-place-"+pleiadesID).css("font-weight","bold"),displayPlace(pleiadesID)}showSearchResults()}else $("#"+widgetContext.widgetID+"-search-results").append("<h3 class='no-search-results'>No matches found for '"+searchString+"'</h3>"),$("#"+widgetContext.widgetID+"-search-results").show()}function hideSearchResults(){$("#"+widgetContext.widgetID+"-search-results-map").hide(),$("#"+widgetContext.widgetID+"-search-results").hide()}function showSearchResults(){widgetContext.displayMap&&($("#"+widgetContext.widgetID+"-search-results-map").show(),searchMap.refresh()),$("#"+widgetContext.widgetID+"-search-results").show()}function hidePlace(){$("#"+widgetContext.widgetID+"-map").hide(),$("#"+widgetContext.widgetID+"-place").hide()}function showPlace(){$("#"+widgetContext.widgetID+"-place").show(),widgetContext.displayMap&&($("#"+widgetContext.widgetID+"-map").show(),placeMap.refresh())}function addSection(name,title,iconURL,strapline){var data={name:name,title:title,iconURL:iconURL,strapline:strapline,widgetContext:widgetContext},html=Handlebars.templates.section(data);$("#"+widgetContext.widgetID+"-sections").append(html),$("#"+widgetContext.widgetID+"-content-"+name).hide(),$("#"+widgetContext.widgetID+"-header-"+name).click(function(){$("#"+widgetContext.widgetID+"-content-"+name).toggle(),toggleIcon(widgetContext.widgetID+"-toggle-"+name)})}function toggleIcon(id){var current_icon=$("#"+id).attr("src"),new_icon=current_icon==widgetContext.imageDir+"icons/down-arrow.png"?widgetContext.imageDir+"icons/right-arrow.png":widgetContext.imageDir+"icons/down-arrow.png";$("#"+id).attr("src",new_icon)}function toggleSelectedLink(id){var element=$("#"+id),current_style=element.css("text-decoration"),new_style=current_style=="underline"?"none":"underline";element.css("text-decoration",new_style)}function getDatasetInfo(id){var datasetInfo;return $.each(dataset,function(key,info){info.id==rootDatasetID&&(datasetInfo=info)}),datasetInfo}function debug(msg){widgetContext.debug&&console.log(msg)}var placeMap={},searchMap={},searchString="";eval(widget_container_tmpl),eval(place_tmpl),eval(section_tmpl),eval(flickr_tmpl),eval(pleiades_tmpl),eval(pelagios_partner_tmpl),eval(error_tmpl),eval(search_tmpl),eval(annotations_tmpl),eval(search_results_tmpl),eval(new_tab_tmpl),eval(about_tmpl);var dataset=$.parseJSON(datasetJSON);typeof $("#"+widgetContext.widgetID)==undefined&&debug("ERROR: $(#"+widgetContext.widgetID+") is undefined"),$("head").append('<link rel="stylesheet" type="text/css" href="'+widgetContext.cssDir+'pelagios.css" media="screen" />');var html=Handlebars.templates.widget_container({widgetContext:widgetContext});$("#"+widgetContext.widgetID).append(html),$("#"+widgetContext.widgetID+"-container").draggable(),this.setTypePlace=function(){var html=Handlebars.templates.place({widgetContext:widgetContext});$("#"+widgetContext.widgetID+"-content").append(html),hidePlace(),widgetContext.icon==1&&($("#"+widgetContext.widgetID+"-container").hide(),$("#"+widgetContext.widgetID+"-icon").click(widgetPopUp),widgetContext.onMouseOver&&($("#"+widgetContext.widgetID+"-icon").mouseover(widgetPopUp),$(document).click(function(){$("#"+widgetContext.widgetID+"-container").hide()}),$("#"+widgetContext.widgetID).click(function(e){return e.stopPropagation(),!1})),$("#"+widgetContext.widgetID+"-close-widget").click(function(){$("#"+widgetContext.widgetID+"-container").hide()})),displayPlace(widgetContext.pleiadesID)},this.setTypeSearch=function(){var html=Handlebars.templates.search({widgetContext:widgetContext});$("#"+widgetContext.widgetID+"-content").append(html);var html=Handlebars.templates.place({widgetContext:widgetContext});$("#"+widgetContext.widgetID+"-content").append(html),hidePlace(),hideSearchResults(),$("#"+widgetContext.widgetID+"-search-form").submit(function(){return searchString=$("input:first").val(),displaySearchResults(),!1})}}var config={URL_PELAGIOS_API_V2:"http://pelagios.dme.ait.ac.at/api/",API_KEY_FLICKR:"ddf82df2aba035bfcf14c12a4eff3335",TIMEOUT_PLEIADES:6e3,TIMEOUT_PELAGIOS:6e4,TIMEOUT_FLICKR:6e3,URL_PLEIADES:"http://pleiades.stoa.org/places/",URL_FLICKR_SEARCH:"http://api.flickr.com/services/rest/?format=json&method=flickr.photos.search",MAX_PHOTOS_FLICKR:30,MSG_PLACE_NOT_FOUND:"The place specified for this widget does not exist in the Pleiades gazetteer.",MSG_TITLE_PLACE_NOT_FOUND:"Error: Unknown Place",MSG_PLEIADES_TIMEOUT:"We cannot display the place name and map at the moment because the Pleiades website is not responding. Apologies for the inconvenience and please try again later.",MSG_TITLE_PLEIADES_TIMEOUT:"Error: Pleiades not responding",NUM_ANNOTATIONS_TO_DISPLAY:20};return{Widget:Widget}})